<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Asientos - El Teniente</title>
    <style>
        :root { --primary: #1a73e8; --secondary: #34a853; --bg: #f1f3f4; --accent: #ff9800; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 10px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        #access-screen { text-align: center; margin-top: 50px; background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 400px; }
        .section { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .section-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; border-bottom: 2px solid var(--primary); display: inline-block; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; }
        .ticket-block { background: #fff8e1; border: 1px dashed var(--accent); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .checkbox-group { background: white; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 4px; }
        .checkbox-item { display: flex; align-items: flex-start; gap: 8px; font-size: 0.85rem; margin-bottom: 6px; cursor: pointer; }
        .checkbox-item input { width: auto; margin-top: 3px; }
        .btn { padding: 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-add { background: #e8f0fe; color: var(--primary); margin-bottom: 15px; border: 1px solid var(--primary); }
        .btn-submit { background: var(--secondary); color: white; font-size: 1.1rem; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="access-screen">
    <div id="geo-status"><h3>Validando ubicaci√≥n...</h3><p>Buscando se√±al GPS...</p></div>
    <div id="manual-pass" class="hidden">
        <p style="color: #d93025; font-weight: bold;">üìç Fuera de rango o sin GPS</p>
        <input type="password" id="passInput" placeholder="Contrase√±a: Teniente01!">
        <button class="btn btn-submit" onclick="verificarClave()">INGRESAR</button>
    </div>
</div>

<div id="main-app" class="container">
    <h2 style="text-align: center; color: var(--primary);">Registro Incidencia - Ticketera</h2>

    <div class="section">
        <div class="section-title">Secci√≥n 1 - Contacto</div>
        <input type="text" id="nombre" placeholder="Nombre y Apellido (Juan Perez)">
        <input type="text" id="rut_contacto" placeholder="RUT (xxxxxxxx-x)">
        <input type="email" id="email" placeholder="Nombre@correo.cl">
    </div>

    <div class="section">
        <div class="section-title">Secci√≥n 2 - Hincha</div>
        <label>¬øEs abonado?</label>
        <select id="es_abonado" onchange="toggleAbonado(this.value)">
            <option value="NO">NO</option><option value="S√ç">S√ç</option>
        </select>
        <div id="area-abonado" class="hidden">
            <label>Vigencia</label>
            <select id="vigencia"><option value="Anual">Anual</option><option value="Semestral">Semestral</option></select>
            <label>Categor√≠a</label>
            <select id="categoria">
                <option value="Adultos">Adultos</option><option value="Mayores">Mayores</option><option value="Joven">Joven</option>
                <option value="Cadete">Cadete</option><option value="Ni√±o">Ni√±o</option><option value="Celest√≠n">Celest√≠n</option>
            </select>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Secci√≥n 3 - Ubicaci√≥n</div>
        <label>Sector</label>
        <select id="sector" onchange="toggleOrientacion(this.value)">
            <option value="" disabled selected>Seleccione...</option>
            <option value="Galer√≠a">Galer√≠a</option><option value="ANDES">ANDES</option>
            <option value="MARQUESINA">MARQUESINA</option><option value="PALCO">PALCO</option>
        </select>
        <div id="area-orientacion" class="hidden">
            <label>Orientaci√≥n</label>
            <select id="posicion"><option value="Sur">Sur</option><option value="Centro">Centro</option><option value="Norte">Norte</option></select>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Secci√≥n 4 - Tickets</div>
        <div id="listado-tickets">
            <div class="ticket-block">
                <label>RUT en ticket</label>
                <input type="text" class="t-rut" placeholder="RUT en ticket">
                <div style="display: flex; gap: 8px;">
                    <div style="flex:1"><label>Fila</label><input type="text" class="t-fila"></div>
                    <div style="flex:1"><label>Asiento</label><input type="text" class="t-asiento"></div>
                </div>
                
                <label>ü™ë Problemas asiento</label>
                <div class="checkbox-group prob-asiento">
                    <label class="checkbox-item"><input type="checkbox" value="Ocupado"> Asiento ocupado por otro</label>
                    <label class="checkbox-item"><input type="checkbox" value="Duplicado"> Dos con el mismo asiento</label>
                    <label class="checkbox-item"><input type="checkbox" value="No existe"> No existe f√≠sicamente</label>
                    <label class="checkbox-item"><input type="checkbox" value="Fila incorrecta"> Fila incorrecta</label>
                    <label class="checkbox-item"><input type="checkbox" value="Distinto"> Distinto al ticket</label>
                    <label class="checkbox-item"><input type="checkbox" value="Otro sector"> Pertenece a otro sector</label>
                    <label class="checkbox-item"><input type="checkbox" value="Reservado"> Reservado (abonado/cortes√≠a)</label>
                </div>

                <label>üéüÔ∏è Conflicto Entrada</label>
                <div class="checkbox-group prob-entrada">
                    <label class="checkbox-item"><input type="checkbox" value="Abonado ocupado"> Abonado ocupado</label>
                    <label class="checkbox-item"><input type="checkbox" value="General en Abonado"> General en asiento Abonado</label>
                    <label class="checkbox-item"><input type="checkbox" value="Cortes√≠a en General"> Cortes√≠a en venta General</label>
                    <label class="checkbox-item"><input type="checkbox" value="Sin asiento"> General sin asiento disponible</label>
                    <label class="checkbox-item"><input type="checkbox" value="Derivado"> Abonado derivado sin aviso</label>
                    <label class="checkbox-item"><input type="checkbox" value="Conflicto tipos"> Conflicto entre tipos entrada</label>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-add" onclick="agregarTicket()">+ AGREGAR OTRO TICKET</button>
    </div>

    <div class="section">
        <div class="section-title">Secci√≥n 5 - Observaciones</div>
        <textarea id="observaciones" rows="3"></textarea>
    </div>

    <button id="btnFinal" class="btn btn-submit" onclick="enviar()">ENVIAR REPORTE</button>
</div>

<script>
    // REEMPLAZA ESTA URL CON LA TUYA DE APPS SCRIPT
    const URL_G = "https://script.google.com/macros/s/AKfycbyZOlRBAcw3tn-VnIYdmAvO615xqBfEZrh-Cu9oA-Mz5Jcj6g65X2Xuh1qgYgwY4VwB/exec";
    const ESTADIO = { lat: -34.1775, lon: -70.7381 };

    window.onload = () => {
        navigator.geolocation.getCurrentPosition(
            (p) => {
                const d = calcDist(p.coords.latitude, p.coords.longitude, ESTADIO.lat, ESTADIO.lon);
                if(d <= 0.8) showApp(); else showManual();
            },
            () => showManual()
        );
    };

    function calcDist(la1, lo1, la2, lo2) {
        const R = 6371;
        const dLat = (la2-la1)*Math.PI/180; const dLon = (lo2-lo1)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function showManual() {
        document.getElementById('geo-status').classList.add('hidden');
        document.getElementById('manual-pass').classList.remove('hidden');
    }

    function verificarClave() {
        if(document.getElementById('passInput').value === "Teniente01!") showApp();
        else alert("Clave Incorrecta");
    }

    function showApp() {
        document.getElementById('access-screen').classList.add('hidden');
        document.getElementById('main-app').style.display='block';
    }

    function toggleAbonado(v) {
        document.getElementById('area-abonado').className = v === "S√ç" ? "" : "hidden";
    }

    function toggleOrientacion(v) {
        document.getElementById('area-orientacion').className = v === "Galer√≠a" ? "hidden" : "";
    }

    function agregarTicket() {
        const listado = document.getElementById('listado-tickets');
        const primerBlock = document.querySelector('.ticket-block');
        const clon = primerBlock.cloneNode(true);
        clon.querySelectorAll('input').forEach(i => {
            if(i.type === 'text') i.value = '';
            else if(i.type === 'checkbox') i.checked = false;
        });
        listado.appendChild(clon);
    }

    async function enviar() {
        const btn = document.getElementById('btnFinal');
        btn.disabled = true;
        btn.innerText = "SINCRO...";

        try {
            const ticketsRecopilados = [];
            const bloques = document.querySelectorAll('.ticket-block');

            bloques.forEach(b => {
                const probAsiento = Array.from(b.querySelectorAll('.prob-asiento input:checked')).map(c => c.value);
                const probEntrada = Array.from(b.querySelectorAll('.prob-entrada input:checked')).map(c => c.value);
                
                ticketsRecopilados.push({
                    rut_ticket: b.querySelector('.t-rut').value || "S/R",
                    fila: b.querySelector('.t-fila').value || "S/F",
                    asiento: b.querySelector('.t-asiento').value || "S/A",
                    prob_asiento: probAsiento,
                    prob_entrada: probEntrada
                });
            });

            const payload = {
                nombre: document.getElementById('nombre').value,
                rut_contacto: document.getElementById('rut_contacto').value,
                email: document.getElementById('email').value,
                es_abonado: document.getElementById('es_abonado').value,
                vigencia: document.getElementById('vigencia') ? document.getElementById('vigencia').value : "N/A",
                categoria: document.getElementById('categoria') ? document.getElementById('categoria').value : "N/A",
                sector: document.getElementById('sector').value,
                posicion: document.getElementById('posicion') ? document.getElementById('posicion').value : "N/A",
                tickets: ticketsRecopilados,
                observaciones: document.getElementById('observaciones').value
            };

            await fetch(URL_G, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            });

            alert("‚úÖ ¬°Sincronizado con √©xito!");
            location.reload();

        } catch (err) {
            alert("Error: " + err.message);
            btn.disabled = false;
            btn.innerText = "ENVIAR REPORTE";
        }
    }
</script>
</body>
</html>
