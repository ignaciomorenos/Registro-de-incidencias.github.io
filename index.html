<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Asientos - El Teniente</title>
    <style>
        :root { --primary: #1a73e8; --secondary: #34a853; --bg: #f8f9fa; --accent: #ff9800; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 10px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
        #access-screen { text-align: center; margin-top: 60px; background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .section { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .section-title { font-weight: bold; color: var(--primary); margin-bottom: 12px; border-bottom: 2px solid var(--primary); display: inline-block; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; }
        .ticket-block { background: #fff8e1; border: 1px dashed var(--accent); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .checkbox-group { background: white; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 4px; }
        .checkbox-item { display: flex; align-items: flex-start; gap: 8px; font-size: 0.85rem; margin-bottom: 6px; cursor: pointer; }
        .checkbox-item input { width: auto; margin-top: 3px; }
        .btn { padding: 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-add { background: #e8f0fe; color: var(--primary); margin-bottom: 15px; border: 1px solid var(--primary); }
        .btn-submit { background: var(--secondary); color: white; font-size: 1.1rem; }
        .hidden { display: none; }
        .otro-text { margin-top: 5px; border-style: dotted !important; }
    </style>
</head>
<body>

<div id="access-screen">
    <div id="geo-status"><h3>Validando ubicaci√≥n...</h3><p>Estadio El Teniente</p></div>
    <div id="manual-pass" class="hidden">
        <p style="color: #d93025; font-weight: bold;">üìç Ubicaci√≥n no detectada</p>
        <input type="password" id="passInput" placeholder="Clave de acceso">
        <button class="btn btn-submit" onclick="verificarClave()">INGRESAR</button>
    </div>
</div>

<div id="main-app" class="container">
    <h2 style="text-align: center; color: var(--primary);">Mejoras Asientos Ticketera</h2>

    <div class="section">
        <div class="section-title">Informaci√≥n del Evento</div>
        <select id="partido" style="background: #e3f2fd; font-weight: bold;">
            <option value="O'higgins vs La Serena - 07/02/2026">O'higgins vs La Serena (07/02)</option>
            <option value="Limache vs O'higgins - 14/02/2026">Limache vs O'higgins (14/02)</option>
            <option value="O'higgins vs Bah√≠a - 18/02/2026">Libertadores: O'higgins vs Bah√≠a (18/02)</option>
            <option value="O'higgins vs Colo-Colo - 21/02/2026">O'higgins vs Colo-Colo (21/02)</option>
        </select>
    </div>

    <div class="section">
        <div class="section-title">Secci√≥n 1 - Contacto Hincha</div>
        <input type="text" id="rut_contacto" placeholder="RUT (xxxxxxxx-x)">
        <input type="email" id="email" placeholder="nombre@correo.cl">
    </div>

    <div class="section">
        <div class="section-title">Secci√≥n 2 - Hincha</div>
        <label>¬øEs abonado?</label>
        <select id="es_abonado" onchange="toggleAbonado(this.value)">
            <option value="NO">NO</option><option value="S√ç">S√ç</option>
        </select>
        <div id="area-abonado" class="hidden">
            <label>Vigencia</label>
            <select id="vigencia"><option>Anual</option><option>Semestral</option></select>
            <label>Categor√≠a</label>
            <select id="categoria_socio">
                <option>Adulto</option><option>Mayores</option><option>Joven</option>
                <option>Cadete</option><option>Ni√±o</option><option>Celest√≠n</option>
            </select>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Secci√≥n 3 - Ubicaci√≥n</div>
        <select id="sector" onchange="toggleOrientacion(this.value)">
            <option value="" disabled selected>Seleccione Sector...</option>
            <option value="Galer√≠a">Galer√≠a</option><option value="ANDES">ANDES</option>
            <option value="MARQUESINA">MARQUESINA</option><option value="PALCO">PALCO</option>
        </select>
        <div id="area-orientacion" class="hidden">
            <select id="posicion"><option>Sur</option><option>Centro</option><option>Norte</option></select>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Secci√≥n 4 - Tickets</div>
        <div id="listado-tickets">
            <div class="ticket-block">
                <input type="text" class="t-rut" placeholder="RUT en ticket">
                <label>Tipo Ticket</label>
                <select class="t-tipo">
                    <option>Adulto</option><option>Mayores</option><option>Joven</option>
                    <option>Cadete</option><option>Ni√±o</option><option>Celest√≠n</option>
                </select>
                <div style="display: flex; gap: 8px;"><input type="text" class="t-fila" placeholder="Fila"><input type="text" class="t-asiento" placeholder="Asiento"></div>
                
                <label>ü™ë Problemas asiento</label>
                <div class="checkbox-group prob-asiento">
                    <label class="checkbox-item"><input type="checkbox" value="Ocupado"> Asiento ocupado por otro</label>
                    <label class="checkbox-item"><input type="checkbox" value="Duplicado"> Mismo asiento</label>
                    <label class="checkbox-item"><input type="checkbox" value="No existe"> No existe f√≠sicamente</label>
                    <label class="checkbox-item"><input type="checkbox" value="Fila incorrecta"> Fila incorrecta</label>
                    <label class="checkbox-item"><input type="checkbox" value="Distinto"> Distinto al ticket</label>
                    <label class="checkbox-item"><input type="checkbox" value="Otro sector"> Otro sector</label>
                    <label class="checkbox-item"><input type="checkbox" value="Reservado"> Reservado</label>
                    <label class="checkbox-item"><input type="checkbox" class="chk-otro"> Otro (especificar):</label>
                    <input type="text" class="otro-text hidden" placeholder="Detalle...">
                </div>

                <label>üéüÔ∏è Conflicto Entrada</label>
                <div class="checkbox-group prob-entrada">
                    <label class="checkbox-item"><input type="checkbox" value="Abonado ocupado"> Abonado ocupado</label>
                    <label class="checkbox-item"><input type="checkbox" value="General en Abono"> Gral en Abono</label>
                    <label class="checkbox-item"><input type="checkbox" value="Cortes√≠a en Gral"> Cortes√≠a en Gral</label>
                    <label class="checkbox-item"><input type="checkbox" value="Gral sin asiento"> Gral sin asiento</label>
                    <label class="checkbox-item"><input type="checkbox" value="Abonado derivado"> Derivado sin aviso</label>
                    <label class="checkbox-item"><input type="checkbox" value="Conflicto tipos"> Conflicto tipos</label>
                    <label class="checkbox-item"><input type="checkbox" class="chk-otro"> Otro (especificar):</label>
                    <input type="text" class="otro-text hidden" placeholder="Detalle...">
                </div>
            </div>
        </div>
        <button class="btn btn-add" onclick="agregarTicket()">+ OTRO TICKET</button>
    </div>

    <div class="section">
        <div class="section-title">Secci√≥n 5 - Observaciones</div>
        <textarea id="observaciones" rows="3"></textarea>
    </div>

    <button id="btnFinal" class="btn btn-submit" onclick="enviar()">ENVIAR REPORTE</button>
</div>

<script>
    const URL_G = "https://script.google.com/macros/s/AKfycbw1ytfBCoi0aeMVyANWaS5AeialatvFjeLoK5y0-ZrXcYnNrHMJMytRjjPEulD6l9E/exec"; 
    const ESTADIO = { lat: -34.1775, lon: -70.7381 };

    window.onload = () => {
        setMatchByDate();
        document.addEventListener('change', e => {
            if(e.target.classList.contains('chk-otro')) {
                e.target.closest('.checkbox-group').querySelector('.otro-text').classList.toggle('hidden', !e.target.checked);
            }
        });
        navigator.geolocation.getCurrentPosition(p => {
            const d = Math.sqrt((p.coords.latitude-ESTADIO.lat)**2 + (p.coords.longitude-ESTADIO.lon)**2);
            if(d <= 0.008) showApp(); else showManual();
        }, showManual);
    };

    function setMatchByDate() {
        const today = new Date().toISOString().split('T')[0];
        const s = document.getElementById('partido');
        if (today === "2026-02-07") s.selectedIndex = 0;
        else if (today === "2026-02-14") s.selectedIndex = 1;
        else if (today === "2026-02-18") s.selectedIndex = 2;
        else if (today === "2026-02-21") s.selectedIndex = 3;
    }

    function showManual() { document.getElementById('geo-status').classList.add('hidden'); document.getElementById('manual-pass').classList.remove('hidden'); }
    function verificarClave() { if(document.getElementById('passInput').value === "Teniente01!") showApp(); else alert("Clave Incorrecta"); }
    function showApp() { document.getElementById('access-screen').classList.add('hidden'); document.getElementById('main-app').style.display='block'; }
    function toggleAbonado(v) { document.getElementById('area-abonado').className = v === "S√ç" ? "" : "hidden"; }
    function toggleOrientacion(v) { document.getElementById('area-orientacion').className = v === "Galer√≠a" ? "hidden" : ""; }

    function agregarTicket() { 
        const clon = document.querySelector('.ticket-block').cloneNode(true); 
        clon.querySelectorAll('input').forEach(i => { if(i.type==='text') i.value=''; else i.checked=false; if(i.classList.contains('otro-text')) i.classList.add('hidden'); }); 
        document.getElementById('listado-tickets').appendChild(clon); 
    }

    async function enviar() {
        const btn = document.getElementById('btnFinal'); btn.disabled = true; btn.innerText = "SINCRO...";
        const tks = []; document.querySelectorAll('.ticket-block').forEach(b => {
            const pa = []; b.querySelectorAll('.prob-asiento input[type="checkbox"]:checked:not(.chk-otro)').forEach(c => pa.push(c.value));
            const oA = b.querySelector('.prob-asiento .otro-text').value; if(oA) pa.push("Otro: "+oA);
            const pe = []; b.querySelectorAll('.prob-entrada input[type="checkbox"]:checked:not(.chk-otro)').forEach(c => pe.push(c.value));
            const oE = b.querySelector('.prob-entrada .otro-text').value; if(oE) pe.push("Otro: "+oE);
            tks.push({ rut_ticket: b.querySelector('.t-rut').value, tipo_entrada: b.querySelector('.t-tipo').value, fila: b.querySelector('.t-fila').value, asiento: b.querySelector('.t-asiento').value, prob_asiento: pa, prob_entrada: pe });
        });
        const payload = { partido: document.getElementById('partido').value, rut_contacto: document.getElementById('rut_contacto').value, email: document.getElementById('email').value, es_abonado: document.getElementById('es_abonado').value, vigencia: document.getElementById('vigencia').value, categoria_socio: document.getElementById('categoria_socio').value, sector: document.getElementById('sector').value, posicion: document.getElementById('posicion').value, tickets: tks, observaciones: document.getElementById('observaciones').value };
        await fetch(URL_G, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        alert("‚úÖ Sincronizado"); location.reload();
    }
</script>
</body>
</html>
