<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Incidencias - El Teniente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none; }
        .btn-primary { background-color: #0056b3; border: none; }
        .btn-primary:hover { background-color: #004494; }
        .hidden { display: none; }
        .form-label { color: #333; }
    </style>
</head>
<body class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card p-4">
                <div class="text-center mb-4">
                    <h2 class="fw-bold">Registro de Incidencias</h2>
                    <p class="text-muted">Piloto Estadio El Teniente</p>
                </div>
                
                <form id="incidentForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">RUT Contacto</label>
                        <input type="text" class="form-control" id="rut_contacto" placeholder="12345678-9" required>
                        <div class="form-text">Debe incluir guion (ej: 12345678-9).</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Correo Electrónico</label>
                        <input type="email" class="form-control" id="email" placeholder="nombre@correo.com" required>
                    </div>
                    
                    <hr>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Sector</label>
                        <select class="form-select" id="sector" onchange="toggleAsiento()" required>
                            <option value="" selected disabled>Seleccione sector...</option>
                            <option value="GALERÍA">GALERÍA (No Numerada)</option>
                            <option value="ANDES">ANDES</option>
                            <option value="PACÍFICO">PACÍFICO</option>
                            <option value="MARQUESINA">MARQUESINA</option>
                        </select>
                    </div>

                    <div id="div_asiento" class="mb-3 hidden">
                        <label class="form-label fw-bold">Fila y Asiento</label>
                        <input type="text" class="form-control" id="asiento" placeholder="Ej: Fila 10, Asiento 5">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo de Ticket / Socio</label>
                        <select class="form-select" id="tipo_ticket" required>
                            <option value="" selected disabled>Seleccione una opción...</option>
                            <option value="Abonado Anual">Abonado Anual</option>
                            <option value="Abonado Semestral">Abonado Semestral</option>
                            <option value="Ticket Individual">Ticket Individual (Compra)</option>
                            <option value="Invitación">Invitación / Cortesía</option>
                            <option value="Socio Adulto">Socio Adulto</option>
                            <option value="Socio Niño">Socio Niño</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Problema Detectado</label>
                        <select class="form-select" id="problema" required>
                            <option value="" selected disabled>Seleccione el problema...</option>
                            <option value="Asiento Duplicado">Asiento Duplicado</option>
                            <option value="Sobreventa">Sobreventa</option>
                            <option value="Error de Lectura">Error de Lectura (Torniquete)</option>
                            <option value="Otro">Otro (Especificar abajo)</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Información Adicional</label>
                        <textarea class="form-control" id="info_adicional" rows="3" placeholder="Comentarios o detalles del caso..."></textarea>
                    </div>

                    <button type="submit" id="submitBtn" class="btn btn-primary w-100 fw-bold py-2">ENVIAR REPORTE</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Tu URL de Apps Script actualizada
        const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyZOlRBAcw3tn-VnIYdmAvO615xqBfEZrh-Cu9oA-Mz5Jcj6g65X2Xuh1qgYgwY4VwB/exec";

        // Función para ocultar/mostrar campo de asiento según sector
        function toggleAsiento() {
            const sector = document.getElementById('sector').value;
            const divAsiento = document.getElementById('div_asiento');
            const inputAsiento = document.getElementById('asiento');
            
            if (sector === "GALERÍA") {
                divAsiento.classList.add('hidden');
                inputAsiento.value = "No Numerada";
            } else {
                divAsiento.classList.remove('hidden');
                inputAsiento.value = "";
                inputAsiento.focus();
            }
        }

        document.getElementById('incidentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            
            // Validación de RUT simple
            const rutValue = document.getElementById('rut_contacto').value;
            if (!rutValue.includes('-')) {
                alert("⚠️ Error: El RUT debe incluir guion (ej: 12345678-9)");
                return;
            }

            // Bloquear botón para evitar doble envío
            btn.disabled = true;
            btn.innerText = "Enviando...";

            const payload = {
                rut_contacto: rutValue,
                email: document.getElementById('email').value,
                sector: document.getElementById('sector').value,
                asiento: document.getElementById('asiento').value,
                tipo_ticket: document.getElementById('tipo_ticket').value,
                problema: document.getElementById('problema').value,
                info_adicional: document.getElementById('info_adicional').value
            };

            try {
                // Envío de datos al Apps Script
                await fetch(URL_GOOGLE, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    body: JSON.stringify(payload)
                });
                
                alert("✅ ¡Reporte enviado con éxito!");
                document.getElementById('incidentForm').reset();
                document.getElementById('div_asiento').classList.add('hidden');
                
            } catch (error) {
                console.error("Error:", error);
                alert("❌ Hubo un error al enviar. Por favor, reintente.");
            } finally {
                btn.disabled = false;
                btn.innerText = "ENVIAR REPORTE";
            }
        });
    </script>
</body>
</html>
